<!DOCTYPE html>
<html lang="en">

<head>
    <title>Warhammer 40,000 10th Edition Combat Calculator by Cees Timmerman, 2024-11-28.</title>
    <style>
        html {
            background-color: black;
            color: white;
            text-align: center;
            font: message-box;
        }

        input {
            text-align: center;
        }

        input[type=number] {
            width: 3em
        }

        input[type=text] {
            width: 2em
        }

        table {
            margin: auto
        }

        .abilities {
            width: 40em !important
        }
    </style>
    <script>
        let squads = {}
        let sheets = [
            "- Adeptus Astartes -",
            `Apothecary
Unit	M	T	SV	W	LD	OC
Primaris Apothecary	6"	4	3+	4	6+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Absolvor Bolt Pistol	18"	1	3+	5	-1	2	Pistol
Reductor Pistol	3"	1	3+	4	-4	2	Pistol
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Close Combat Weapon	Melee	4	3+	4	0	1	-
Abilities Narthecium, Gene Seed Recovery, Leader, Fire Discipline
Rules Leader, Oath of Moment, Pistol
Keywords: Character Faction: Adeptus Astartes Grenades Imperium Infantry Primaris Apothecary Tacticus`,
            `Techmarine
Unit	M	T	SV	W	LD	OC
Techmarine	6"	4	2+	4	6+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Forge Bolter	24"	3	2+	5	-1	2	-
Grav-pistol	12"	1	3+	4	-1	2	Anti-vehicle 2+, Pistol
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Omnissian Power Axe	Melee	4	3+	6	-2	2	-
Servo-arm	Melee	1	3+	8	-2	3	Extra Attacks
Abilities TechmarineBlessing of the OmnissiahVengeance of the OmnissiahLeaderArtificer Armour
Rules LeaderOath of MomentPistolExtra Attacks
Keywords: Character Faction: Adeptus Astartes Grenades Imperium Infantry Tacticus Techmarine Warlord`,
            `Eradicator Squad
Models
 1x Eradicator: Bolt Pistol, Close Combat Weapon, Melta Rifle
 1x Eradicator Sergeant: Bolt Pistol, Close Combat Weapon, Melta Rifle
 1x Eradicator with Multi-melta: Bolt Pistol, Close Combat Weapon, Multi-melta
Unit	M	T	SV	W	LD	OC
Eradicator Squad	5"	6	3+	3	6+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Bolt Pistol (x3)	12"	1	3+	4	0	1	Pistol
Melta Rifle (x2)	18"	1	3+	9	-4	D6	Heavy, Melta 2
Multi-melta	18"	2	4+	9	-4	D6	Heavy, Melta 2
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Close Combat Weapon (x3)	Melee	3	3+	4	0	1	-
Abilities
Total Obliteration: Each time a ranged attack made by a model in this unit targets a Monster or Vehicle model, you can re-roll the Hit roll, you can re-roll the Wound roll and you can re-roll the Damage roll.
Rules Oath of MomentPistolHeavyMelta
Keywords: Eradicator Squad Faction: Adeptus Astartes Gravis Grenades Imperium Infantry`,
            `Infernus Squad
Models
 5x Infernus Marines: Bolt Pistol, Close Combat Weapon, Pyreblaster
 1x Infernus Sergeant: Bolt Pistol, Close Combat Weapon, Pyreblaster
Unit	M	T	SV	W	LD	OC
Infernus Squad	6"	4	3+	2	6+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Bolt Pistol (x6)	12"	1	3+	4	0	1	Pistol
Pyreblaster (x6)	12"	D6	N/A	5	0	1	Ignores Cover, Torrent
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Close Combat Weapon (x6)	Melee	3	3+	4	0	1	-
Abilities Purge the Foe
Rules Oath of MomentPistolIgnores CoverTorrent
Keywords: Faction: Adeptus Astartes Grenades Imperium Infantry Infernus Squad Tacticus`,
            `Tactical Squad
Models
 7x Tactical Marine: Bolt Pistol, Boltgun, Close Combat Weapon
 1x Tactical Marine Sergeant: Close Combat Weapon, Bolt Pistol, Astartes Chainsword
 1x Tactical Marine w/Heavy or Special Weapon: Bolt Pistol, Close Combat Weapon, Missile Launcher
 1x Tactical Marine w/Special Weapon: Bolt Pistol, Close Combat Weapon, Flamer
Unit	M	T	SV	W	LD	OC
Tactical Squad	6"	4	3+	2	6+	2
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Bolt Pistol (x10)	12"	1	3+	4	0	1	Pistol
Boltgun (x7)	24"	2	3+	4	0	1	-
➤ Missile Launcher - Frag (x0)	48"	D6	4+	4	0	1	Blast, Heavy
➤ Missile Launcher - Krak	48"	1	4+	9	-2	D6	Heavy
Flamer	12"	D6	N/A	4	0	1	Ignores Cover, Torrent
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Close Combat Weapon (x10)	Melee	2	3+	4	0	1	-
Astartes Chainsword	Melee	4	3+	4	-1	1	-
Abilities Combat Squads
Rules Oath of MomentPistolHeavyBlastTorrentIgnores Cover
Keywords: Battleline Faction: Adeptus Astartes Grenades Imperium Infantry Tactical Squad`,
            `Impulsor
Unit	M	T	SV	W	LD	OC
Impulsor	12"	9	3+	11	6+	2
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
➤ Bellicatus Missile Array - Frag (x0)	48"	D6	3+	4	0	1	Blast
➤ Bellicatus Missile Array - Icarus (x0)	48"	D3	3+	8	-1	2	Anti-Fly 2+
➤ Bellicatus Missile Array - Krak (x0)	48"	1	3+	8	-2	D6	-
Ironhail Skytalon Array (x0)	36"	8	3+	4	0	1	Anti-Fly 4+, Sustained Hits 1
Ironhail Heavy Stubber	36"	3	3+	4	0	1	Rapid Fire 3
Storm Bolter (x2)	24"	2	3+	4	0	1	Rapid Fire 2
Fragstorm Grenade Launcher (x0)	18"	D6	3+	4	0	1	Blast
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Armoured Tracks	Melee	3	4+	6	0	1	-
Abilities TransportAssault VehicleShield Dome
Rules Deadly Demise D3Firing Deck 6Oath of MomentRapid Fire
Keywords: Dedicated Transport Faction: Adeptus Astartes Imperium Impulsor Transport Vehicle`,
            `Redemptor Dreadnought 
Unit	M	T	SV	W	LD	OC
Redemptor Dreadnought	8"	10	2+	12	6+	4
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Icarus Rocket Pod	24"	D3	3+	8	-1	2	Anti-fly 2+
Heavy Onslaught Gatling Cannon	24"	12	3+	6	0	1	Devastating Wounds
➤ Macro Plasma Incinerator - Standard (x0)	36"	D6+1	3+	8	-3	2	Blast
➤ Macro Plasma Incinerator - Supercharge (x0)	36"	D6+1	3+	9	-4	3	Blast, Hazardous
Onslaught Gatling Cannon	24"	8	3+	5	0	1	Devastating Wounds
Heavy Flamer (x0)	12"	D6	N/A	5	-1	1	Ignores Cover, Torrent
Twin Fragstorm Grenade Launcher (x0)	18"	D6	3+	4	0	1	Blast, Twin-linked
Twin Storm Bolter	24"	2	3+	4	0	1	Rapid Fire 2, Twin-linked
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Redemptor Fist	Melee	5	3+	12	-2	3	-
Abilities Duty EternalDamaged: 1-4 Wounds Remaining
Rules Deadly Demise D3Oath of MomentAnti-HazardousBlastIgnores CoverTorrentTwin-linked
Keywords: Deathwing Faction: Adeptus Astartes Imperium Redemptor Dreadnought Vehicle Walker`,
            `Terminator Squad 
Models
 1x Terminator Sergeant: Storm Bolter, Power Weapon
 1x Terminator w/ Heavy Weapon: Chainfist, Assault Cannon
 0x Terminator w/ Heavy Weapon: Chainfist, Cyclone Missile Launcher & Storm Bolter (Cyclone Missile Launcher, Storm Bolter)
 0x Terminator w/ Heavy Weapon: Chainfist, Heavy Flamer
 3x Terminator w/ Power Fist: Power Fist, Storm Bolter
Unit	M	T	SV	W	LD	OC
Terminator Squad	5"	5	2+	3	6+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Storm Bolter (x4)	24"	2	3+	4	0	1	Rapid Fire 2
Assault Cannon	24"	6	3+	6	0	1	Devastating Wounds
➤ Cyclone Missile Launcher - Frag (x0)	36"	2D6	3+	4	0	1	Blast
➤ Cyclone Missile Launcher - Krak (x0)	36"	2	3+	9	-2	D6	-
Heavy Flamer (x0)	12"	D6	N/A	5	-1	1	Ignores Cover, Torrent
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Power Weapon	Melee	4	3+	5	-2	1	-
Chainfist	Melee	3	4+	8	-2	2	Anti-Vehicle 3+
Power Fist (x3)	Melee	3	3+	8	-2	2	-
Abilities Teleport HomerFury of the FirstInvulnerable Save 4
Rules Deep StrikeOath of MomentRapid FireAnti-Devastating WoundsIgnores CoverTorrent
Keywords: Faction: Adeptus Astartes Imperium Infantry Terminator Terminator Squad`,
            // Space Marines Faction – Includes 12 Armies, based on various Adeptus Astartes Chapters:
            //"- Black Templars -",
            //"- Blood Angels -",
            "- Dark Angels -",
            `Deathwing Knights 
Models
 4x Deathwing Knight
 1x Knight Master: Great Weapon of the Unforgiven
Unit	M	T	SV	W	LD	OC
Deathwing Knight (x4)	5"	5	2+	4	6+	1
Knight Master	5"	5	2+	4	6+	1
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Flail of the Unforgiven	Melee	5	2+	6	-2	2	Devastating Wounds, Sustained Hits 1
Relic Weapon (x0)	Melee	6	2+	7	-2	2	Lethal Hits
Mace of absolution (x4)	Melee	4	2+	6	-2	2	Anti-Monster 4+, Anti-Vehicle 4+
Power Weapon (x0)	Melee	5	2+	6	-2	2	-
Abilities
Inner Circle: Each time an attack is allocated to a model in this unit, subtract 1 from the Damage characteristic of that attack.
Invulnerable Save: 4+
Attached Unit: If a Character unit from your army with the Leader ability can be attached to a Terminator Squad, it can be attached to this unit instead.
Teleport Homer: At the start of the battle, you can set up one Teleport Homer token for this unit anywhere on the battlefield that is not in your opponent’s deployment zone. If you do, once per battle, you can target this unit with the Rapid Ingress Stratagem for 0CP, but when resolving that Stratagem, you must set this unit up within 3" horizontally of that token and not within 9" horizontally of any enemy models. That token is then removed.
Watcher in the Dark: Once per battle, in any phase, this unit can summon a Watcher in the Dark. When it does, until the end of the phase, models in this unit have the Feel No Pain 4+ ability against mortal wounds.
Rules Deep StrikeOath of MomentDevastating WoundsSustained HitsAnti-
Keywords: Deathwing Deathwing Knights Faction: Adeptus Astartes Faction: Dark Angels Imperium Infantry Terminator`,
            `Deathwing Terminator Squad 
Models
 1x Deathwing Sergeant: Power Weapon, Storm Bolter
 1x Deathwing Terminator: Power Fist, Storm Bolter
 2x Deathwing Terminator w/ Chainfist: Chainfist, Storm Bolter
 0x Deathwing Terminator w/ Heavy Weapon: Chainfist, Assault Cannon
 0x Deathwing Terminator w/ Heavy Weapon: Chainfist, Cyclone Missile Launcher & Storm Bolter
 0x Deathwing Terminator w/ Heavy Weapon: Chainfist, Heavy Flamer
 1x Deathwing Terminator w/ Heavy Weapon: Chainfist, Plasma Cannon
Unit	M	T	SV	W	LD	OC
Deathwing Sergeant	5"	5	2+	3	6+	1
Deathwing Terminator (x8)	5"	5	2+	3	6+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Storm Bolter (x4)	24"	2	3+	4	0	1	Rapid Fire 2
Assault Cannon (x0)	24"	6	3+	6	0	1	Devastating Wounds
➤ Cyclone Missile Launcher - Frag (x0)	36"	2D6	3+	4	0	1	Blast
➤ Cyclone Missile Launcher - Krak (x0)	36"	2	3+	9	-2	D6	-
Heavy Flamer (x0)	12"	D6	N/A	5	-1	1	Ignores Cover, Torrent
➤ Plasma Cannon - Standard (x0)	36"	D3	3+	7	-2	1	Blast
➤ Plasma Cannon - Supercharge	36"	D3	3+	8	-3	2	Blast, Hazardous
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Power Weapon	Melee	4	3+	5	-2	1	-
Power Fist	Melee	3	3+	8	-2	2	-
Chainfist (x3)	Melee	3	4+	8	-2	2	Anti-Vehicle 3+
Abilities Invulnerable Save 4DeathwingAttached UnitTeleport Homer
Rules Deep StrikeOath of MomentAnti-Devastating WoundsBlastIgnores CoverTorrentHazardous
Keywords: Deathwing Deathwing Terminator Squad Faction: Adeptus Astartes Faction: Dark Angels Imperium Infantry Terminator`,
            `Lion El'Jonson
Unit	M	T	SV	W	LD	OC
Lion El'Jonson	8"	9	2+	10	5+	4
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
➤ Arma Luminis - bolt (x0)	12"	4	2+	4	-1	2	Pistol
➤ Arma Luminis - plasma	12"	2	2+	8	-3	2	Pistol
Melee Weapons	Range	A	WS	S	AP	D	Keywords
➤ Fealty - strike	Melee	8	2+	12	-4	4	Lethal Hits
➤ Fealty - sweep (x0)	Melee	16	2+	6	-3	1	Sustained Hits 1
Abilities Primarch of the First LegionThe Emperor's ShieldDark Angels BodyguardInvulnerable save
Primarch of the First Legion All Secrets RevealedMartial Exemplar [Aura]No Hiding From the Watchers [Aura]
Rules Deep StrikeFights FirstOath of MomentPistolLethal HitsSustained Hits
Keywords: Character Epic Hero Faction: Adeptus Astartes Faction: Dark Angels Imperium Lion El'Jonson Monster Primarch Warlord`,
            "- Deathwatch -",
            `Corvus Blackstar
Unit	M	T	SV	W	LD	OC
Corvus Blackstar	20+"	10	3+	14	6+	0
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Hurricane bolter	24"	6	3+	4	0	1	Rapid Fire 6, Twin-linked
Twin assault cannon (x0)	24"	6	3+	6	0	1	Devastating Wounds, Twin-linked
Twin lascannon	48"	1	3+	12	-3	D6+1	Twin-linked
Blackstar rocket launcher (x0)	30"	D6+1	3+	5	0	1	Blast
Stormstrike missile launcher (x2)	48"	1	3+	10	-2	3	-
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Armoured hull	Melee	3	4+	6	0	1	-
Abilities Blackstar Cluster LauncherDamaged: 1-5 Wounds RemainingTransportAuspex Array
Rules Deadly Demise D6HoverStealthAssigned AgentsRapid FireTwin-linkedIgnores Cover
Keywords: Aircraft Allied Units Corvus Blackstar Deathwatch Faction: Agents of the Imperium Fly Imperium Ordo Xenos Retinue Transport Vehicle`,
            //"- Grey Knights -",
            //"- Imperial Fists -",
            //"- Iron Hands -",
            //"- Raven Guard -",
            //"- Salamanders -",
            //"- Space Wolves -",
            "- Ultramarines -",
            `Roboute Guilliman 
Unit	M	T	SV	W	LD	OC
Roboute Guilliman	8"	9	2+	10	5+	4
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Hand of Dominion	30"	2	2+	6	-2	2	Rapid Fire 2
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Hand of Dominion	Melee	7	2+	14	-4	4	Lethal Hits
The Emperor's Sword	Melee	14	2+	8	-3	2	Devastating Wounds
Abilities Author of the CodexUltramarines BodyguardArmour of FateSupreme CommanderInvulnerable Save 4
Rules Oath of MomentLethal HitsRapid FireDevastating Wounds
Keywords: Character Epic Hero Faction: Adeptus Astartes Faction: Ultramarines Imperium Monster Primarch Roboute Guilliman Warlord`,
            //"- White Scars -",
            // https://www.adeptusars.com/guides/factions Imperium of Man Faction – Includes 5 Armies:
            "- Adeptus Custodes -",
            `Custodian Guard 
Models
 2x Custodian Guard (Guardian Spear): Guardian Spear
 1x Custodian Guard (Sentinel Blade & Praesidium Shield): Sentinel blade
 1x Custodian Guard (Vexilla, Praesidium Shield & Misericordia): Misericordia, Vexilla
Unit	M	T	SV	W	LD	OC
Custodian Guard (x2)	6"	6	2+	3	6+	3
Custodian Guard (Shield)	6"	6	2+	4	6+	3
Custodian Guard (Vexilla)	6"	6	2+	4	6+	3
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Guardian Spear (x2)	24"	2	2+	4	-1	2	Assault
Sentinel Blade	12"	2	2+	4	-1	2	Assault, Pistol
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Guardian Spear (x2)	Melee	5	2+	7	-2	2	-
Sentinel Blade	Melee	5	2+	6	-2	1	-
Misericordia	Melee	5	2+	5	-2	1	-
Abilities Stand VigilSentinel StormInvulnerable Save 4Praesidium ShieldVexilla
Rules Deep StrikeMartial Ka'tahAssaultPistol
Keywords: Battleline Custodian Guard Faction: Adeptus Custodes Imperium Infantry`,
            "- Adeptus Mechanicus -",
            "- Adepta Sororitas -",
            "- Astra Militarum -",
            `Ratling Snipers 
Models
 5x Ratling Snipers: Close Combat Weapon, Sniper Rifle
Unit	M	T	SV	W	LD	OC
Ratling Snipers (x5)	6"	2	6+	1	8+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Sniper Rifle (x5)	36"	1	3+	4	-2	2	Heavy, Precision
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Close Combat Weapon (x5)	Melee	1	5+	2	0	1	-
Abilities Shoot Sharp and Scarper
Rules InfiltratorsStealthHeavyPrecision
Keywords: Faction: Astra Militarum Imperium Infantry Ratling Ratling Snipers`,
            `Scout Sentinels 
Unit	M	T	SV	W	LD	OC
Scout Sentinel	10"	7	3+	7	7+	2
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Hunter-killer Missile	48"	1	4+	14	-3	D6	One Shot
Autocannon (x0)	48"	2	4+	9	-1	3	-
Heavy Flamer (x0)	12"	D6	N/A	5	-1	1	Ignores Cover, Torrent
Lascannon (x0)	48"	1	4+	12	-3	D6+1	-
Militarum Multi-laser	36"	4	4+	6	0	1	-
➤ Missile Launcher - Frag (x0)	48"	D6	4+	4	0	1	Blast, Heavy
➤ Missile Launcher - Krak (x0)	48"	1	4+	9	-2	D6	Heavy
➤ Plasma Cannon - Standard (x0)	36"	D3	4+	7	-2	1	Blast
➤ Plasma Cannon - Supercharge (x0)	36"	D3	4+	8	-3	2	Blast, Hazardous
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Close Combat Weapon	Melee	2	4+	6	0	1	-
Sentinel Chainsaw	Melee	3	4+	6	-1	1	-
Abilities Daring Recon
Rules Deadly Demise 1Scouts 9"One Shot
Keywords: Faction: Astra Militarum Imperium Regiment Scout Sentinels Smoke Squadron Vehicle Walker`,
            "- Imperial Knights -",
            "- Agents of the Imperium -",
            // Chaos Forces Faction – Includes 6 Armies:
            "- Chaos -",
            // XXX: Why ever choose unfocused witchfire?
            `Be'lakor 
Unit	M	T	SV	W	LD	OC
Be'lakor	12"	10	4+	18	6+	5
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
➤ Betraying Shades - witchfire (x0)	18"	9	2+	5	-2	1	Devastating Wounds, Ignores Cover, Psychic
➤ Betraying Shades - focused witchfire	18"	12	2+	6	-3	1	Devastating Wounds, Hazardous, Ignores Cover, Psychic
Melee Weapons	Range	A	WS	S	AP	D	Keywords
➤ The Blade of Shadows - sweep (x0)	Melee	14	2+	8	-3	1	-
➤ The Blade of Shadows - strike	Melee	6	2+	14	-4	D6+1	Lethal Hits
Abilities The Dark Master (Aura)Shadow FormInvulnerable SaveDamaged: 1-6 wounds remaining
Shadow Form Wreathed in Shadows (Aura, Psychic)Pall of Despair (Aura, Psychic)Shadow Lord (Aura, Psychic)
Rules Deep StrikeThe Shadow of ChaosWarp RiftsStealthDeadly Demise D6Devastating WoundsPsychicHazardousIgnores CoverLethal Hits
Keywords: Be'lakor Chaos Character Daemon Epic Hero Faction: Legiones Daemonica Fly Monster Psyker Warlord`,
            //"- Death Guard -",  // Are these not Chaos Space Marines?
            "- Dark Mechanicum -",
            "- The Lost and The Damned -",  // Misc chaos fans.
            "- Deathwatch -",
            // Xenos
            "- Necrons -",
            `C'tan Shard of the Deceiver 
Unit	M	T	SV	W	LD	OC
C'tan Shard of the Deceiver	6"	11	4+	12	6+	6
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Cosmic insanity	18"	6	2+	6	-2	1	Anti-CHARACTER 4+, Devastating Wounds, Precision
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Golden fists	Melee	8	2+	8	-3	3	-
Abilities Invulnerable SaveGrand IllusionNecrodermisEnslaved Star God
Rules Annihilation ProtocolReanimation ProtocolsDeadly Demise D6StealthFeel No Pain 5+Anti-Devastating WoundsPrecision
Keywords: C'tan Shard of the Deceiver Character Epic Hero Faction: Necrons Fly Monster`,
            `C'tan Shard of the Nightbringer 
Unit	M	T	SV	W	LD	OC
C'tan Shard of the Nightbringer	6"	11	4+	12	6+	4
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Gaze of death	18"	D3	2+	12	-2	D6+3	-
Melee Weapons	Range	A	WS	S	AP	D	Keywords
➤ Scythe of the Nightbringer - strike	Melee	6	2+	14	-4	D6+2	Devastating Wounds
➤ Scythe of the Nightbringer - sweep (x0)	Melee	14	2+	8	-2	2	-
Abilities Invulnerable SaveDrain LifeNecrodermisEnslaved Star God
Rules Annihilation ProtocolReanimation ProtocolsDeadly Demise D6Feel No Pain 5+
Keywords: C'tan Shard of the Nightbringer Character Epic Hero Faction: Necrons Fly Monster`,
            `C'tan Shard of the Void Dragon 
Unit	M	T	SV	W	LD	OC
C'tan Shard of the Void Dragon	6"	11	4+	12	6+	4
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Spear of the Void Dragon	12"	1	2+	4	-3	D6+2	Anti-VEHICLE 2+
Voltaic storm	18"	D6+3	2+	7	-1	2	Blast, Sustained Hits 2
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Canoptek tail blades	Melee	6	2+	6	-1	1	Extra Attacks
➤ Spear of the Void Dragon - strike	Melee	5	2+	12	-3	D6+2	Anti-VEHICLE 2+
➤ Spear of the Void Dragon - sweep	Melee (x0)	10	2+	8	-1	2	-
Abilities Invulnerable SaveMatter AbsorptionNecrodermisEnslaved Star God
Rules Annihilation ProtocolReanimation ProtocolsDeadly Demise D6Feel No Pain 5+Extra AttacksAnti-BlastSustained Hits
Keywords: C'tan Shard of the Void Dragon Character Epic Hero Faction: Necrons Fly Monster`,
            `C'tan Shard of the Void Dragon 
Unit	M	T	SV	W	LD	OC
C'tan Shard of the Void Dragon	6"	11	4+	12	6+	4
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Spear of the Void Dragon	12"	1	2+	4	-3	D6+2	Anti-VEHICLE 2+
Voltaic storm	18"	D6+3	2+	7	-1	2	Blast, Sustained Hits 2
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Canoptek tail blades	Melee	6	2+	6	-1	1	Extra Attacks
➤ Spear of the Void Dragon - strike	Melee	5	2+	12	-3	D6+2	Anti-VEHICLE 2+
➤ Spear of the Void Dragon - sweep	Melee (x0)	10	2+	8	-1	2	-
Abilities Invulnerable SaveMatter AbsorptionNecrodermisEnslaved Star God
Rules Annihilation ProtocolReanimation ProtocolsDeadly Demise D6Feel No Pain 5+Extra AttacksAnti-BlastSustained Hits
Keywords: C'tan Shard of the Void Dragon Character Epic Hero Faction: Necrons Fly Monster`,
            `Ghost Ark 
Unit	M	T	SV	W	LD	OC
Ghost Ark	10"	9	3+	14	7+	3
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Gauss flayer array (x2)	24"	5	3+	4	0	1	Lethal Hits, Rapid Fire 5
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Armoured bulk	Melee	3	4+	6	0	1	-
Abilities Invulnerable Save 4, Repair Barge
Transport Ghost Ark
Rules Annihilation ProtocolDeadly Demise D3Reanimation ProtocolsLethal HitsRapid Fire
Keywords: Dedicated Transport Faction: Necrons Fly Ghost Ark Transport Vehicle`,
            // New Recruit adds (x20) to Gretchin but leaves out (x3) for Unit listing here :(
            `Skorpekh Destroyers 
Models
 3x Skorpekh Destroyer: Skorpekh hyperphase weapons
Unit	M	T	SV	W	LD	OC
Skorpekh Destroyers	8"	6	3+	3	7+	2
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Skorpekh hyperphase weapons (x3)	Melee	4	3+	7	-2	2	-
Abilities Whirling Onslaught
Rules Annihilation ProtocolReanimation Protocols
Keywords: Destroyer Cult Faction: Necrons Infantry Skorpekh Destroyers`,
            "- Aeldari -",
            "- Orks -",
            `Boyz 
Models
 1x Boss Nob: Power klaw and slugga (Power klaw, Slugga)
 8x Boy w/ Shoota and close combat weapon: Close combat weapon, Shoota
 9x Boy w/ Slugga and choppa: Choppa, Slugga
 1x Boy w/ Big shoota and close combat weapon: Big shoota, Close combat weapon
 1x Boy w/ Rokkit launcha and close combat weapon: Close combat weapon, Rokkit launcha
Unit	M	T	SV	W	LD	OC
Boy	6"	5	5+	1	7+	2
Boss Nob	6"	5	5+	2	7+	2
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Kombi-weapon (x0)	24"	1	5+	4	0	1	Anti-Infantry 4+, Devastating Wounds, Rapid Fire 1
Slugga (x10)	12"	1	5+	4	0	1	Pistol
Shoota (x8)	18"	2	5+	4	0	1	Rapid Fire 1
Big shoota	36"	3	5+	5	0	1	Rapid Fire 2
Rokkit launcha	24"	D3	5+	9	-2	3	Blast
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Big choppa (x0)	Melee	3	3+	7	-1	2	-
Power klaw	Melee	3	4+	9	-2	2	-
Close combat weapon (x10)	Melee	2	3+	4	0	1	-
Choppa (x9)	Melee	3	3+	4	-1	1	-
Abilities Get Da Good BitzBodyguard
Rules Waaagh!PistolRapid FireBlast
Keywords: Battleline Boyz Faction: Orks Grenades Infantry Mob`,
            `Big Mek 
Unit	M	T	SV	W	LD	OC
Big Mek	6"	5	3+	6	7+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Kustom mega-blasta (x0)	24"	3	5+	9	-2	D6	Hazardous
Traktor blasta	36"	1	5+	10	-2	D6+1	Anti-Fly 3+, Devastating Wounds
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Drilla	Melee	2	3+	12	-3	3	-
Power klaw (x0)	Melee	4	3+	9	-2	2	-
Abilities More DakkaShokk-boostaGitfinder Gogglez
Rules Waaagh!LeaderIgnores CoverDevastating WoundsAnti-
Abilities (Leader) Leader
Keywords: Big Mek Character Faction: Orks Grenades Infantry Mek`,
            `Gretchin 
Models
 10x Gretchin: Close combat weapon, Grot blasta
 1x Runtherd: Grot-smacka, Slugga
Unit	M	T	SV	W	LD	OC
Gretchin (x10)	6"	2	7+	1	8+	2
Runtherd	6"	5	5+	2	7+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Grot blasta (x10)	12"	1	4+	3	0	1	Pistol
Slugga	12"	1	5+	4	0	1	Pistol
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Close combat weapon (x10)	Melee	1	5+	2	0	1	-
Grot-smacka	Melee	3	3+	5	0	1	-
Abilities RuntherdThievin’ Scavengers
Rules Waaagh!Pistol
Keywords: Battleline Faction: Orks Gretchin Grots Infantry`,
            `Ghazghkull Thraka 
Models
 1x Ghazghkull Thraka: Gork’s Klaw, Mork’s Roar
 1x Makari: Makari’s stabba
Unit	M	T	SV	W	LD	OC
Ghazghkull Thraka	5"	6	2+	10	6+	4
Makari	5"	6	7+	1	8+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Mork’s Roar	36"	12	5+	5	0	1	Rapid Fire 4
Melee Weapons	Range	A	WS	S	AP	D	Keywords
➤ Gork’s Klaw - strike	Melee	6	2+	14	-3	4	-
➤ Gork’s Klaw - sweep (x0)	Melee	12	2+	8	-2	2	-
Makari’s stabba	Melee	1	4+	3	0	1	Devastating Wounds
Abilities Supreme CommanderProphet of Da Great Waaagh!Invulnerable Save (4+): GhazghkullInvulnerable Save (2+*): Makari
Rules Waaagh!LeaderLethal HitsRapid FireDevastating Wounds
Abilities (Leader) Leader
Abilities (Ghazghkull’s Waaagh! Banner (Aura)) Ghazghkull’s Waaagh! Banner (Aura)
Keywords: Character Epic Hero Faction: Orks Ghazghkull Thraka Infantry Warboss Warlord`,
            `Meganobz 
Models
 1x Meganob w/ Killsaw and power klaw: Killsaw, Power klaw
 1x Meganob w/ Kombi-weapon and killsaw: Killsaw, Kombi-weapon
 1x Meganob w/ Kombi-weapon and power klaw: Kombi-weapon, Power klaw
 1x Meganob w/ Kustom shoota and killsaw: Killsaw, Kustom shoota
 1x Meganob w/ Kustom shoota and power klaw: Kustom shoota, Power klaw
 1x Meganob w/ Twin killsaw: Twin killsaw
Unit	M	T	SV	W	LD	OC
Meganobz	5"	6	2+	3	7+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Kombi-weapon (x2)	24"	1	5+	4	0	1	Anti-Infantry 4+, Devastating Wounds, Rapid Fire 1
Kustom shoota (x2)	18"	4	5+	4	0	1	Rapid Fire 2
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Killsaw (x3)	Melee	2	4+	12	-3	2	-
Power klaw (x3)	Melee	3	4+	9	-2	2	-
Twin killsaw	Melee	2	4+	12	-3	2	Twin-linked
Rules Waaagh!Feel No PainDevastating WoundsAnti-Rapid FireTwin-linked
Abilities (Krumpin’ Time) Krumpin’ Time
Keywords: Faction: Orks Grenades Infantry Mega Armour Meganobz`,
            `Zodgrod Wortsnagga 
Unit	M	T	SV	W	LD	OC
Zodgrod Wortsnagga	6"	5	5+	5	7+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Squigstoppa	12"	1	5+	4	-1	1	Anti-Monster 4+, Pistol
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Da Grabzappa	Melee	5	2+	7	-2	2	-
Abilities Super RuntsSpecial Dose
Rules Feel No Pain 6+Waaagh!LeaderPistolAnti-
Keywords: Character Epic Hero Faction: Orks Infantry Zodgrod Wortsnagga`,

            "- Tyranids -",
            `Termagants 
Models
 1x Termagant w/ Shardlauncher: Chitinous Claws and Teeth, Shardlauncher
 1x Termagant w/ Spike Rifle: Chitinous Claws and Teeth, Spike Rifle
 1x Termagant w/ Strangleweb: Chitinous Claws and Teeth, Strangleweb
 7x Termagants: Chitinous Claws and Teeth, Fleshborer
Unit	M	T	SV	W	LD	OC
Termagants (x10)	6"	3	5+	1	8+	2
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Shardlauncher	18"	D3	4+	5	0	1	Blast, Heavy
Spike Rifle	24"	1	4+	4	-1	1	Heavy
Strangleweb	18"	D6	N/A	2	0	1	Assault, Devastating Wounds, Torrent
Fleshborer (x7)	18"	1	4+	5	0	1	Assault
Termagant Devourer (x0)	18"	2	4+	4	0	1	-
Termagant Spinefist (x0)	12"	2	4+	3	0	1	Assault, Pistol, Twin-linked
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Chitinous Claws and Teeth (x10)	Melee	1	4+	3	0	1	-
Abilities Skulking Horrors
Rules SynapseHeavyBlastAssaultDevastating WoundsTorrent
Keywords: Battleline Endless Multitude Faction: Tyranids Great Devourer Infantry Termagants`,

            "- Leagues of Votann -",
            `Ûthar the Destined 
Unit	M	T	SV	W	LD	OC
Ûthar the Destined	5"	5	3+	5	7+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Volkanite disintegrator	18"	3	2+	5	0	1	Devastating Wounds
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Blade of the Ancestors	Melee	5	2+	6	-3	2	Devastating Wounds
Abilities Ancestral FortuneThe DestinedLeaderInvulnerable SaveGrim EfficiencyRampart crest
Rules LeaderEye of the AncestorsRuthless EfficiencyDevastating Wounds
Keywords: Character Epic Hero Faction: Leagues of Votann Infantry Warlord Ûthar the Destined`,
            "- Pasted -",
        ]

        function import_sheets() {
            for (let sheet of sheets) {
                const new_squads = parse_sheet(sheet)
                log(`Adding ${Object.keys(new_squads)} from sheets.`)
                squads = {
                    ...squads,
                    ...new_squads
                }
            }
        }
        function add_squads() {
            let html = ""
            for (let key in squads) {
                html += `<option value="${key}">${key}</option>`
            }
            source.innerHTML = html
            target.innerHTML = html
        }
        function set_source_squad(key) {
            let squad = squads[key]
            if (typeof squad === "string") squad = parse_sheet(squad)
            let html = squad["weapons"] ? `<table><tr>
                    <th>Weapon</th>
                    <th>Count</th>
                    <th>Range</th>
                    <th title="Attacks">A</th>
                    <th title="Ballistic/Weapon Skill">BS/WS</th>
                    <th title="Strength">S</th>
                    <th title="Armor Piercing">AP</th>
                    <th title="Damage">D</th>
                    <th>Keywords</th>
                </tr>` : ''
            let i = 0
            log("LOADING squad " + JSON.stringify(squad))
            source_abilities.value = (squad.abilities || []).join(", ")
            source_keywords.value = (squad.keywords || []).join(", ")

            source_models.innerHTML = Object.keys(squad.models).join(', ')
            models.style.display = source_models.innerHTML ? 'block' : 'none'
            for (let key in squad["weapons"]) {
                log("Weapon: " + key)
                i++
                let weapon = squad["weapons"][key]
                html += `<tr><td id="weapon${i}">${key}</td>
<td><input id="count${i}" type="number" value="${weapon.count || 0}"></td>
<td><input id="range${i}" type="number" value="${weapon.R}"></td>
<td><input id="attacks${i}" type="text" value="${weapon.A}"></td>
<td><input id="skill${i}" type="number" value="${parseInt(weapon.WS)}"></td>
<td><input id="strength${i}" type="number" value="${weapon.S}"></td>
<td><input id="piercing${i}" type="number" value="${-Math.abs(weapon.AP || 0)}"></td>
<td><input id="damage${i}" type="text" value="${weapon.D}"></td>
<td><input id="keywords${i}" type="text" value="${('' + (weapon.keywords || '')).split(/, */).join(", ")}" style="width: 10em"></td></tr>`
            }
            weapons.innerHTML = html + "</table>"
        }

        function set_target_squad(key) {
            let squad = squads[key]
            if (typeof squad === "string") {
                log("Dynamic squad string load.")
                squad = parse_sheet(squad)[key]
            }
            target_size.value = squad.size || 1
            target_abilities.value = (squad.abilities || []).join(", ")
            target_keywords.value = (squad.keywords || []).join(", ")
            target_rules.value = (squad.rules || []).join(", ")
            let html = ""
            for (let k in squad.units) {
                html += `<option value="${k}">${k}</option>`
                const unit = squad.units[k]
                toughness.value = unit.T || ''
                save.value = parseInt(unit.SV) || ''
                wounds.value = unit.W || ''
                leadership.value = parseInt(unit.LD) || 0
                let mo = /Invulnerable Save (\d+)/.exec(squad.abilities)  // Ghost Ark
                invuln_save.value = mo && parseInt(mo[1]) || ""
                mo = /Feel No Pain (\d+)/.exec(squad.abilities)
                fnp_save.value = mo && parseInt(mo[1]) || ""
            }
            target_unit.innerHTML = html
            if (target_unit.options.length) {
                target_unit.options[0].selected = true
                target_unit.onchange()
            }
        }

        function set_target_unit(key) {
            let unit = squads[target.value].units[key]
            toughness.value = unit.T || ''
            save.value = unit.SV || ''
            wounds.value = unit.W || ''
        }

        let d6 = _ => 1 + Math.floor(Math.random() * 6)
        function geti(id) {
            let rv = 0
            let s = document.getElementById(id).value
            let m;
            if (m = /[+-]\d+/.exec(s)) rv = parseInt(m[0])
            if (m = /(\d*)D(\d+)/.exec(s)) {
                for (let i = 0; i < (m[1] || 1); ++i) rv += 1 + Math.floor(parseInt(m[2]) * Math.random())
                return rv
            }
            return parseInt(s)
        }
        let gets = id => document.getElementById(id).value
        let log_enabled = true
        function log(s) {
            if (log_enabled) console.log(s)
        }
        function get_keyword_value(keywords, id) {
            for (let kw of keywords) {
                if (kw.indexOf(id) > -1) {
                    return parseInt(/\d+/.exec(kw))
                }
            }
            return 0
        }
        function calculate(distance) {
            let damage = 0

            let source_abilities = gets("source_abilities").toUpperCase().split(/, */).join(", ")
            let source_keywords = gets("source_keywords").toUpperCase().split(/, */).join(", ")
            let source_is_vehicle = source_keywords.includes("VEHICLE")
            let source_is_monster = source_keywords.includes("MONSTER")
            let target_abilities = gets("target_abilities").toUpperCase().split(/, */).join(", ")
            let target_keywords = gets("target_keywords").toUpperCase().split(/, */).join(", ")
            let target_rules = gets("target_rules").toUpperCase().split(/, */).join(", ")
            const T = parseInt(toughness.value)
            let SV = parseInt(save.value)
            let W = parseInt(wounds.value)
            let LD = parseInt(leadership.value)

            let inches = parseFloat(distance)
            let html = ""
            let times = geti("rounds")
            log_enabled = times < 5

            const weapon_spreads = {}
            log("Calculating...")

            // If a unit is equipped with one or more Pistols, unless it is a MONSTER or VEHICLE unit, it can either shoot with its Pistols or with all of its other ranged weapons. Declare whether such a unit will shoot with its Pistols or its other ranged weapons before selecting targets.
            let has_rifle = false
            for (let i = 1; i < 50; ++i) {
                let weapon = document.getElementById(`weapon${i}`)
                if (weapon === null) break

                let weapon_keywords = gets(`keywords${i}`).toUpperCase().split(/, */)
                if (geti(`range${i}`) > 0 && !weapon_keywords.includes("PISTOL")) {
                    has_rifle = true
                    log(`${weapon.innerText} is not a PISTOL.`)
                    break
                }
            }
            let pistols_only = !has_rifle || (!source_is_vehicle && !source_is_monster && inches < 1) || prefer_pistols.checked
            if (pistols_only) log("The only ranged attacks will be using pistols.")

            // Use up to 49 weapons.
            for (let i = 1; i < 50; ++i) {
                let weapon = document.getElementById(`weapon${i}`)
                if (weapon === null) break;
                weapon = weapon.innerText
                // Skip unequipped weapons.
                let count = geti(`count${i}`)
                if (count < 1) continue

                log(`WEAPON: ${weapon}`)
                let melee_done = false
                let R = geti(`range${i}`) || 0

                const weapon_keywords = gets(`keywords${i}`).toUpperCase().split(/, */)
                let is_pistol = weapon_keywords.includes("PISTOL")
                if (pistols_only && R > 0 && !is_pistol) {
                    log("Pistols only.")
                    continue
                }
                if (is_pistol && !pistols_only) {
                    log("Skipping pistol.")
                    continue
                }

                if (R < 2) {  // Fight within 2" over barricade: https://www.wargamer.com/warhammer-40k/cover
                    R = 1
                    // Melee
                    if (melee_done && !weapon_keywords.includes("EXTRA ATTACKS")) continue
                    melee_done = true // NOSONAR
                    // if (target_keywords.includes("FIGHTS FIRST")) {
                    // TODO: Weapon inputs for target and bidirectional combat simulation.
                    // }
                } else {
                    // Auspex Array: Ranged weapons equipped by the bearer have the [IGNORES COVER] ability.
                    log("Auspex Array grants IGNORES COVER to ranged weapons.")
                    weapon_keywords.push("IGNORES COVER")
                }
                if (R <= inches) {
                    log(`${weapon} out of range. ${R} <= ${inches}`)
                    continue
                }
                if (target_keywords.includes("LONE OPERATIVE") && inches > 12) {
                    log(`Lone operative hidden.`)
                    continue
                }

                const WS = geti(`skill${i}`) || 0
                const S = geti(`strength${i}`)
                const AP = Math.abs(geti(`piercing${i}`))
                const TOTAL_OBLITERATION = source_abilities.includes("TOTAL OBLITERATION") && R > 1 && (target_keywords.includes("MONSTER") || target_keywords.includes("VEHICLE"))
                weapon_spreads[weapon] = {}
                for (let time = 0; time < times * count; ++time) {
                    let take_battleshock = false
                    let A = geti(`attacks${i}`)
                    // Each time a [RAPID FIRE X] weapon targets a unit within half that weapon’s range, the Attacks characteristic of that weapon is increased by the amount denoted by ‘x’.
                    let rf = get_keyword_value(weapon_keywords, "RAPID FIRE")
                    if (rf && inches < R / 2) {
                        A += rf
                        log(`+${rf} RAPID FIRE attacks.`)
                    }
                    // BLAST adds 1 attack per 5 units in the target unit.
                    if (weapon_keywords.includes("BLAST")) {
                        let blast_attacks = Math.floor(geti("target_size") / 5)
                        if (blast_attacks > 0) {
                            A += blast_attacks
                            log(`+${blast_attacks} BLAST attacks.`)
                        }
                    }

                    log(`${weapon} in range; ${R} > ${inches}. Attacking ${A} times.`)
                    for (let attack = 1; attack <= A; ++attack) {
                        ///////////////
                        // Roll to hit.
                        //
                        let hits = 1
                        let lethal_hits = false
                        if (!source_keywords.includes("TORRENT")) {  // Torrent autohits.
                            let hit_roll = d6()
                            log(`Hit roll ${attack}: ${hit_roll}`)
                            // Re-rolls
                            // Total Obliteration: Each time a ranged attack made by a model in this unit targets a Monster or Vehicle model, you can re-roll the Hit roll, you can re-roll the Wound roll and you can re-roll the Damage roll. TODO
                            if (TOTAL_OBLITERATION && hit_roll < WS) {
                                hit_roll = d6()
                                log(`Total Obliteration re-roll: ${hit_roll}`)
                            }
                            // Whirling Onslaught: Each time a unit in this unit makes a melee attack, re-roll a Hit roll of 1. If this unit made a Charge move this turn, you can re-roll the Hit roll instead.
                            if (source_abilities.includes("WHIRLING ONSLAUGHT") && R < 2) {
                                if (hit_roll === 1) {
                                    hit_roll = d6()
                                    log(`Whirling Onslaught hit 1 reroll to ${hit_roll}`)
                                }
                            }
                            // Only natural/unmodified rolls are critical.
                            if (hit_roll === 1) {
                                log("Critical miss.")
                                continue
                            }
                            if (hit_roll == 6) {
                                log("Critical hit.")
                                let sh_bonus = get_keyword_value(weapon_keywords, "SUSTAINED HITS")
                                if (sh_bonus) {
                                    hits += sh_bonus
                                    log(`+${sh_bonus} sustained hits.`)
                                }
                                // Each time an attack is made with a LETHAL HITS weapon, a Critical Hit automatically wounds the target.
                                lethal_hits = weapon_keywords.includes("LETHAL HITS")
                                if (lethal_hits) log("Lethal hits.")
                            } else {
                                // Not crit hit, even if the roll is modified to a 6.
                                if (weapon_keywords.includes("HEAVY")) {
                                    log(`Assuming HEAVY weapon remained stationary. +1 to Hit of ${hit_roll}.`)
                                    hit_roll += 1
                                }
                                // If every unit (XXX) in a unit has STEALTH, then each time a ranged attack is made against it, subtract 1 from that attack’s Hit roll.
                                if (target_rules.includes("STEALTH")) {
                                    hit_roll -= 1
                                    log("Stealthy target. -1 to hit.")
                                }

                                if (hit_roll < WS) {
                                    log(`Miss. ${hit_roll} < ${WS} WS`)
                                    continue
                                }
                            }
                        }
                        log(`${hits} hits.`)
                        // Purge the Foe: In your Shooting phase, after this unit has shot, you can select one enemy Infantry unit hit by one or more of those attacks made with a Pyreblaster. That enemy unit must take a Battle-shock test.
                        if (weapon.includes("Pyreblaster") && source_abilities.includes("PURGE THE FOE")) {
                            log("Target must take battleshock test.")
                            take_battleshock = true
                        }

                        for (let hit = 0; hit < hits; ++hit) {
                            if (!lethal_hits) {
                                /////////////////
                                // Roll to wound.
                                //
                                let threshold = 5
                                if (S >= 2 * T)
                                    threshold = 2
                                else if (S > T)
                                    threshold = 3
                                else if (S == T)
                                    threshold = 4
                                else if (2 * S <= T)
                                    threshold = 6

                                // https://www.wargamer.com/warhammer-40k/abilities#twin-linked
                                let to_wound_rolls = TOTAL_OBLITERATION || weapon_keywords.includes("TWIN-LINKED") ? 2 : 1
                                let wound_roll
                                for (let wi = 1; wi <= to_wound_rolls; ++wi) {
                                    wound_roll = d6()
                                    for (let kw of weapon_keywords) {
                                        if (kw.indexOf("ANTI-") > -1) {
                                            let anti_what = /ANTI-(\w+)/.exec(kw)[1].toUpperCase()
                                            let anti_how = parseInt(/\d+/.exec(kw))
                                            if (target_keywords.includes(anti_what) && wound_roll >= anti_how) {
                                                log(`ANTI-${anti_what} crits ${anti_how}+. Wound roll ${wound_roll} -> 6.`)
                                                wound_roll = 6  // ANTI- grants crits.
                                            }
                                        }
                                    }
                                    // TODO: Wound roll bonus of -1 or +1. https://wahapedia.ru/wh40k10ed/the-rules/core-rules/#2.-Wound-Roll
                                    if (wound_roll >= threshold) break
                                    if (wi < to_wound_rolls) log(`Rerolling ${wi}/${to_wound_rolls} to wound. ${wound_roll} < ${threshold}`)
                                }

                                if (wound_roll < threshold) {
                                    log(`No wound. ${wound_roll} < ${threshold}`)
                                    continue
                                }
                                // https://www.newrecruit.eu/wiki/wh40k-10e/warhammer-40%2C000-10th-edition/rules/devastating-wounds
                                // Each time an attack is made a [DEVASTATING WOUNDS] weapon, if that attack scores a Critical Wound, no saving throw of any kind can be made against that attack (including invulnerable saving throws but not Feel No Pain damage negation!?). Such attacks are only allocated to units after all other attacks made by the attacking unit have been allocated and resolved. XXX
                                let devastating_wounds = (wound_roll === 6 && weapon_keywords.includes("DEVASTATING WOUNDS"))
                                if (devastating_wounds) log("Devastating wounds (no +/++ save)")
                                else log(`Wound roll ${wound_roll} >= ${threshold}`)
                                if (!devastating_wounds) {
                                    ////////////
                                    // To save.
                                    //
                                    let save_roll = d6()
                                    if (save_roll === 6) {
                                        log("Critical armor save.")  // XXX: https://www.reddit.com/r/killteam/comments/phzrr6/6_save_normal_save_always_critical_save_too/ says yes but AP guards said 7+ to save?
                                        continue
                                    }
                                    // Benefit of Cover: https://www.wargamer.com/warhammer-40k/cover
                                    if (R > 1 && cover.checked && !source_keywords.includes("IGNORES COVER")) {
                                        if (SV <= 3 && AP == 0) {
                                            log(`No benefit of cover for armor save. ${save_roll}`)
                                        } else {
                                            log(`Benefit of cover; +1 to armor save roll ${save_roll}.`)
                                            save_roll += 1
                                        }
                                    }
                                    // If a unit has an invulnerable save, the player can choose to use that instead of their normal save. Invulnerable saves cannot be modified by an attack’s AP. https://ageofminiatures.com/warhammer-40k-rules-explained/#:~:text=If%20a%20unit%20has%20an,AP.
                                    // https://www.newrecruit.eu/wiki/wh40k-10e/warhammer-40%2C000-10th-edition/rules/feel-no-pain in addition to regular armor save or invuln_save. XXX: Using both here to not calc which is best.
                                    if (save_roll - AP >= SV) {
                                        log(`Saved by armor. ${save_roll} -${AP}AP >= ${SV}SV`)
                                        continue
                                    }
                                    let invuln_save = geti("invuln_save")
                                    if (save_roll >= invuln_save) {
                                        log(`Saved by invulnerable. ${save_roll} >= ${invuln_save}`)
                                        continue
                                    }
                                }
                            }
                            log(`No save.`)

                            /////////
                            // Damage
                            // Re-roll -> division -> multiplication -> subtraction -> addition -> negation per damage.
                            let D = geti(`damage${i}`)
                            // re-roll
                            // Total Obliteration: Each time a ranged attack made by a model in this unit targets a Monster or Vehicle model, you can re-roll the Hit roll, you can re-roll the Wound roll and you can re-roll the Damage roll.
                            let new_D = geti(`damage${i}`)  // TODO: calc average instead.
                            if (TOTAL_OBLITERATION && D < new_D) {
                                log(`Damage roll: ${D}`)
                                D = new_D
                                log(`Total Obliteration re-roll: ${D}`)
                            }
                            // division
                            if (target_abilities.includes("NECRODERMIS")) {
                                log(`Necrodermis halves initial ${D} damage (rounded up).`)
                                D = Math.ceil(D / 2)
                            }
                            // subtraction
                            // Duty Eternal: Each time an attack is allocated to this model, subtract 1 from the Damage characteristic of that attack
                            if (target_abilities.includes("DUTY ETERNAL") && D > 1) {  // D can't go < 1 unless stated. https://www.reddit.com/r/Warhammer40k/comments/145dc9e/comment/jz822h2/
                                log(`Duty Eternal -1 D.`)
                                --D
                            }
                            // addition
                            if (inches < R / 2) {
                                let melta_bonus = get_keyword_value(weapon_keywords, "MELTA")
                                if (melta_bonus) {
                                    D += melta_bonus
                                    log(`MELTA bonus, +${melta_bonus} damage.`)
                                }
                            }
                            // negation
                            // Feel No Pain x+: Each time this unit would lose a wound, roll one D6: if the result equals or exceeds ‘x’, that wound is not lost. https://wahapedia.ru/wh40k10ed/the-rules/core-rules/#:~:text=attack%20is%20lost.-,FEEL%20NO%20PAIN,-Some%20warriors%20refuse - Not prevented by DEVASTATING WOUNDS even though this is thematically also a save (+++) that can prevent devastation.
                            for (let d = 0; d < D; ++d) {
                                if (d6() >= geti("fnp_save")) {
                                    log("Saved 1 mortal wound by Feel No Pain (+++).")
                                    D -= 1  // This is a negate; not a modifier which can't normally go below 1 according to "Rules Commentary": https://www.reddit.com/r/Warhammer40k/comments/1eibdkb/comment/lg5nmn5/
                                    // TODO: Abilities like Refuse To Yield that half damage (rounded up as stated above and not in the fricking ability).
                                }
                            }
                            log(`Target squad takes ${D} damage!`)
                            damage += D
                            // Dealt damage causes mortal wounds, not to be confused with presave or preFNP wounds! By anthropomorphing vehicles and bunkers like that, i'm surprised there aren't more evil animated versions of those like by Khorne and Final Fantasy.
                            weapon_spreads[weapon][D] = (weapon_spreads[weapon][D] || 0) + 1
                        }  // hits
                    }  // attacks
                    // You take a Battle-shock test for a unit by rolling 2D6 and attempting to equal or exceed its Leadership stat. If the test fails, you can’t target the unit with Stratagems, it can’t contest objectives, and you risks losing models when it falls back from combat. https://www.wargamer.com/warhammer-40k/battle-shock#:~:text=You%20take%20a%20Battle%2Dshock,it%20falls%20back%20from%20combat.
                    if (take_battleshock) {
                        if (d6() + d6() < LD) log(`Target is battle-shocked!`)
                        else log("Battle-shock test passed.")
                    }
                }  // rounds
            }  // weapons
            html += `Average ${(damage / times).toFixed(2)} damage; ${(damage / times / W).toFixed(2)} kills.`
            html += `<br><table border=1><tr><th>Damage</th><th>Count</th><th>%</th></tr>`
            for (let weapon in weapon_spreads) {
                html += `<tr><th colspan=2>${weapon}</th></tr>`
                for (let k in weapon_spreads[weapon]) {
                    html += `<tr><td>${k}<td>${weapon_spreads[weapon][k]}</td><td>${(weapon_spreads[weapon][k] / times * 100).toFixed(2)}%</td></tr>`
                }
            }
            //Object.entries(weapon_spreads).forEach(d => speadhtml += `<tr><td>${d[0]}</td><td>${d[1]}</td></tr>`)
            //let damages = Object.keys(spread).map(k => [k, spread[k]])
            //let damages = Object.entries(spread).sort((a, b) => b - a)
            //damages.sort((a, b) => b - a)
            //damages.forEach(d => html += `<tr><td>${d[0]}</td><td>${d[1]}</td></tr>`)
            //}
            result.innerHTML = html + "</table>"
        }

        document.onpaste = (event) => {
            log(`Pasted types: ${event.clipboardData.types}`)
            const html = event.clipboardData.getData("text/html")
            window.types = event.clipboardData.types
            window.html = html
            const new_squads = parse_sheet(event.clipboardData.getData("text/plain"))

            squads = {
                ...squads,
                ...new_squads
            }
            alert(`Imported ${name}.`)
            add_squads()
        }
        function parse_sheet(s) {
            /* NewRecruit.eu format:
Apothecary 
Unit	M	T	SV	W	LD	OC
Primaris Apothecary	6"	4	3+	4	6+	1
Ranged Weapons	Range	A	BS	S	AP	D	Keywords
Absolvor Bolt Pistol	18"	1	3+	5	-1	2	Pistol
Reductor Pistol	3"	1	3+	4	-4	2	Pistol
Melee Weapons	Range	A	WS	S	AP	D	Keywords
Close Combat Weapon	Melee	4	3+	4	0	1	-
Abilities Narthecium, Gene Seed Recovery, Leader, Fire Discipline
Rules Leader, Oath of Moment, Pistol
Keywords: Character Faction: Adeptus Astartes Grenades Imperium Infantry Primaris Apothecary Tacticus

Wahapedia format:
Lion El’jonson
(⌀60mm)

M
8"
T
9
Sv
2+
W
10
Ld
5+
OC
4
INVULNERABLE SAVE
3+
RANGED WEAPONS
RANGE
A
BS
S
AP
D
Arma Luminis – bolt [pistol]	
12"
4
2+
4
-1
2
Arma Luminis – plasma [pistol]	
12"
2
2+
8
-3
2
MELEE WEAPONS
RANGE
A
WS
S
AP
D
Fealty – strike [lethal hits]	
Melee
8
2+
12
-4
4
Fealty – sweep [sustained hits 1]	
Melee
16
2+
6
-3
1
            */
            log(`Parsing ${s}`)
            let squads = {}
            let squad = {
                "size": 0,
                "models": {},
                "units": {},
                "weapons": {},
                "keywords": [],
                "abilities": [],
            }
            let name = "PASTED"
            let mode = ""
            parse_loop:
            for (let line of s.split('\n')) {
                if (name === "PASTED") {
                    name = line.trim()
                    continue
                }
                ///////////////////////
                // NewRecruit.eu format
                let cols = line.split('\t')
                if (cols.length === 7) {  // Unit
                    mode = "unit"
                    if (cols[1] === "M") continue  // Skip header.
                    //log(`NewRecruit unit table row: ${cols}`)
                    // let count = /\(x(\d+)\)/.exec(cols[0])
                    // count = count && count[1] || 1
                    // squad.size += count
                    const unit_name = cols[0].replace(/\(x\d+\)/, '').trim()
                    const unit = squad.units[unit_name] || { "count": 1 }
                    unit.name = unit_name
                    unit.M = parseInt(cols[1])
                    unit.T = parseInt(cols[2])
                    unit.SV = parseInt(cols[3])
                    unit.W = parseInt(cols[4])
                    unit.LD = parseInt(cols[5])
                    unit.OC = parseInt(cols[6])
                    if (name === "PASTED") name = unit.name  // In case user didn't copy sheet name.
                    squad.units[unit.name] = unit
                    if (!squad.models) squad.size += unit.count
                    //log(`Added model to squad: ${JSON.stringify(unit, null, 4)}`)
                }
                else if (cols.length === 8) {  // Weapon
                    mode = "weapon"
                    if (cols[2] === "A") continue  // Skip headers.
                    let weapon_name = cols[0]

                    //log(`${weapon_name} Weapon stats: ${cols}`)
                    let weapon = {
                        "count": cols[0].includes("(x0)") ? 0 : (parseInt(/\d+/.exec(cols[0])) || 1),
                        "R": parseInt(cols[1]) || 0,
                        "A": cols[2],
                        "WS": parseInt(cols[3]) || 0,
                        "S": parseInt(cols[4]),
                        "AP": parseInt(cols[5]),
                        "D": cols[6],
                        "keywords": cols[7].trim().split(/, */),
                    }
                    squad.weapons[cols[0]] = weapon
                }
                for (let word of ["Abilities", "Keywords", "Rules"]) {
                    if (line.startsWith(word)) {
                        mode = word
                        squad[word.toLowerCase()] = line.slice(word.length + 1).replace(/([^A-Z (])([A-Z])/g, '$1\t$2').split('\t')  // TODO: Use HTML for New Recruit copy? XXX: includes() works well enough for now.
                    }
                }
                if (line.trim() === "Models") {
                    mode = "model"
                    continue
                }
                //log(`Parsing ${mode}: ${line}`)
                if (mode === "model") {
                    const mo = /(\d+)x ([^:]+)/.exec(cols[0])
                    log(`NewRecruit models table row: ${mo}`)
                    if (mo) {
                        count = parseInt(mo[1]) || 1
                        model_name = mo[2]
                        squad.size += count
                        squad.models[model_name] = { "count": count }
                    }
                } else if (mode === "Abilities") {
                    const mo = /^([^:]+): (.*)/.exec(line)
                    if (mo) {
                        ability = mo[1]
                        val = parseInt(mo[2])
                        if (val) ability += ' ' + val
                        //log(`Line '''${line}''' has ${mode}: '''${ability}'''`)
                        squad[mode.toLowerCase()].push(ability)
                    }
                }
            }
            squads[name] = squad
            //log(`Parsed squads: ${JSON.stringify(squads, null, 4)}`)
            log(`Parsed squads: ${JSON.stringify(squads)}`)
            return squads
        }
        function filter(which, what) {
            what = what.toLowerCase()
            document.querySelectorAll(`#${which}>option`).forEach(o => o.hidden = !(o.innerText.toLowerCase().includes(what) || squads[o.innerText].keywords.join(",").toLowerCase().includes(what) || squads[o.innerText].abilities.join(",").toLowerCase().includes(what)))
        }
    </script>
</head>

<body onload="import_sheets(); add_squads()">
    <h1>Warhammer 40,000 10th Edition Combat Calculator</h1>
    <div>
        Source <label>filter <input style="width:5em" onchange="filter('source', this.value)"></label> squad <select
            id="source" onchange="set_source_squad(this.value)"></select>
        <div id="models" style="display: none">Models: <span id="source_models"></span></div>
        <table>
            <tr>
                <td><label for="source_keywords">Keywords</label></td>
                <td><input id="source_keywords" type="text" class="abilities"></td>
            </tr>
            <tr>
                <td><label for="source_abilities">Abilities</label></td>
                <td><input id="source_abilities" type="text" class="abilities"></td>
            </tr>
        </table>
        <div id="weapons"></div>
    </div><br>
    <div>
        Target <label>filter <input style="width:5em" onchange="filter('target', this.value)"></label> squad <select
            id="target" onchange="set_target_squad(this.value)"></select>
        <label>Size <input id="target_size" type="number"></label>
        Unit <select id="target_unit" onchange="set_target_unit(this.value)"></select><br><br>
        <table>
            <tr>
                <td><label for="target_keywords">Keywords</label></td>
                <td><input id="target_keywords" type="text" class="abilities"></td>
            </tr>
            <tr>
                <td><label for="target_abilities">Abilities</label></td>
                <td><input id="target_abilities" type="text" class="abilities"></td>
            </tr>
            <tr>
                <td><label for="target_rules">Rules</label></td>
                <td><input id="target_rules" type="text" class="abilities"></td>
            </tr>
        </table>
        <label title="Toughness">T <input id="toughness" type="number"></label>
        <label title="Save">SV <input id="save" type="number"></label>
        <label title="Wounds">W <input id="wounds" type="number"></label>
        <label title="Leadership">LD <input id="leadership" type="number"></label>
        <label title="Invulnerable Save">SV++ <input id="invuln_save" type="text"></label>
        <label title="Feel No Pain Save">FNP+++ <input id="fnp_save" type="text"></label>
    </div>
    <br>
    <div>
        <label>Distance <input id="distance" type="number" value="2" min="0" step="0.5">" </label>
        <label>Cover <input id="cover" type="checkbox"></label>
        <label>Prefer Pistols <input id="prefer_pistols" type="checkbox"> </label>
        <label>Rounds <input id="rounds" type="number" value="1" min="1"></label>
        <input type="button" value="Calculate" onclick="calculate(distance.value)">
    </div>
    <br>
    <div id="result">

    </div>
</body>

</html>