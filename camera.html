<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Camera / QR scanner, by Cees Timmerman 2022-07-25</title>
	<link rel="icon"
		href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 112 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“·</text></svg>">
	<style>
		body {
			background-color: black;
			color: white;
		}

		img,
		video {
			border: 1px solid blue;
		}

		.box {
			background: #ffffff99;
			border: 1px solid red;
			color: black;
			font-size: 0.5em;
			position: absolute;
			word-break: break-all;
		}

		#pix {
			max-height: 40%;
			overflow: auto;
		}
	</style>
</head>

<body>
	<div>
		<label for="audioSource">Audio: </label><select id="audioSource"></select>
		<label for="videoSource">Video: </label><select id="videoSource"></select>
		<button onclick="snap()">Snapshot</button><br>
		<video autoplay muted playsinline></video>
		<div id="overlay"></div>
		<div id="pix"></div>
		<div id="log"></div>
	</div>
	<script>
		'use strict'

		const pixEl = document.getElementById('pix')
		const logEl = document.getElementById('log')
		const vidEl = document.querySelector('video')
		const vidX = vidEl.offsetLeft
		const vidY = vidEl.offsetTop
		const overlay = document.getElementById('overlay')
		const audSel = document.querySelector('select#audioSource')
		const vidSel = document.querySelector('select#videoSource')
		audSel.onchange = setSource
		vidSel.onchange = setSource

		navigator.mediaDevices.enumerateDevices().then(devices => {
			devices.forEach(device => {
				const option = document.createElement('option')
				option.value = device.deviceId
				if (device.kind === 'audioinput') {
					option.text = device.label || `Microphone ${audSel.length + 1}`
					audSel.appendChild(option)
				} else if (device.kind === 'videoinput') {
					option.text = device.label || `Camera ${vidSel.length + 1}`
					vidSel.appendChild(option)
				}
			})
		}).catch(err => console.log(err))

		let scanner = null
		let barcodeDetector = null
		async function setSource() {
			const audioSource = audSel.value
			const videoSource = vidSel.value
			const query = {
				audio: { deviceId: audioSource ? { exact: audioSource } : undefined },
				video: { deviceId: videoSource ? { exact: videoSource } : undefined },
			}
			await navigator.mediaDevices.getUserMedia(query)
				.then(src => vidEl.srcObject = src)
				.catch(err => console.log(err))
			
			if (!('BarcodeDetector' in window)) return
			barcodeDetector = new BarcodeDetector()
			clearInterval(scanner)
			scanner = setInterval(scan, 500)
		}

		async function snap() {
			var canvas = document.createElement('canvas')
			canvas.width = vidEl.videoWidth
			canvas.height = vidEl.videoHeight
			canvas.getContext('2d').drawImage(vidEl, 0, 0)
			/*
			// download
			const a = document.createElement('a')
			a.download = "screenshot.jpg"
			a.href = canvas.toDataURL('image/jpg')
			a.click()
			*/
			const img = document.createElement('img')
			img.src = canvas.toDataURL('image/jpg')
			img.width = 320
			img.onclick = e => scan(img)
			pixEl.appendChild(img)

			logEl.innerText = '' + img
			const barcodes = await scan(img)
			const label = document.createElement('div')
			label.className = 'label'
			barcodes.forEach(barcode => {
				label.innerHTML = `${barcode.format}<br><a href="${barcode.rawValue}">${barcode.rawValue}</a>`
			})
			pixEl.appendChild(label)
			label.scrollIntoView()
		}

		const log = msg => logEl.innerHTML += msg + '<br>'

		async function scan(img) {
			if (!img) img = vidEl
			const barcodes = await barcodeDetector.detect(img)
			overlay.innerText = ''
			for (let i = 0; i < barcodes.length; ++i) {
				let barcode = barcodes[i]
				let box = document.createElement('div')
				box.className = 'box'
				box.innerHTML = `<a href="${barcode.rawValue}">${barcode.rawValue}</a>`
				box.style.left = (vidX + barcode.boundingBox.x) + 'px'
				box.style.top = (vidY + barcode.boundingBox.y) + 'px'
				box.style.height = barcode.boundingBox.height + 'px'
				box.style.width = barcode.boundingBox.width + 'px'
				overlay.appendChild(box)
			}
			return barcodes
		}
	</script>
	<button onclick="document.body.innerText = document.body.innerHTML">View source</button>
</body>

</html>