<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Camera / QR scanner</title>
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 112 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“·</text></svg>">
	<style>
		body {
			background-color: black;
			color: white;
		}

		img,
		video {
			border: 1px solid red;
		}
	</style>
</head>

<body>
	<div>
		<label for="audioSource">Audio source: </label><select id="audioSource"></select>
		<label for="videoSource">Video source: </label><select id="videoSource"></select>
		<button onclick="snap()">Snapshot</button>
		<div id="log"></div>
	</div>
	<video autoplay muted playsinline></video>
	<script>
		'use strict'

		var videoElement = document.querySelector('video')
		var audioSelect = document.querySelector('select#audioSource')
		var videoSelect = document.querySelector('select#videoSource')
		audioSelect.onchange = setSource
		videoSelect.onchange = setSource
		
		navigator.mediaDevices.enumerateDevices().then(devices => {
			devices.forEach(device => {
				const option = document.createElement('option')
				option.value = device.deviceId
				if (device.kind === 'audioinput') {
					option.text = device.label || `Microphone ${audioSelect.length + 1}`
					audioSelect.appendChild(option)
				} else if (device.kind === 'videoinput') {
					option.text = device.label || `Camera ${videoSelect.length + 1}`
					videoSelect.appendChild(option)
				}
			})
		}).catch(err => console.log(err))

		function setSource() {
			const audioSource = audioSelect.value
			const videoSource = videoSelect.value
			const query = {
				audio: { deviceId: audioSource ? { exact: audioSource } : undefined },
				video: { deviceId: videoSource ? { exact: videoSource } : undefined },
			}
			navigator.mediaDevices.getUserMedia(query)
			.then(src => videoElement.srcObject = src)
			.catch(err => console.log(err))
		}

		function snap() {
			var canvas = document.createElement('canvas')
			canvas.width = videoElement.videoWidth
			canvas.height = videoElement.videoHeight
			canvas.getContext('2d').drawImage(videoElement, 0, 0)
			/*
			// download
			const a = document.createElement('a')
			a.download = "screenshot.jpg"
			a.href = canvas.toDataURL('image/jpg')
			a.click()
			*/
			const img = document.createElement('img')
			img.src = canvas.toDataURL('image/jpg')
			img.width = 320
			document.body.appendChild(img)
			document.getElementById('log').innerText = ''
			scan(img)
		}

		const log = msg => document.getElementById('log').innerHTML += msg + '<br>'

		async function scan(img) {
			if (!('BarcodeDetector' in window)) return
			const supportedFormats = await BarcodeDetector.getSupportedFormats()
				.then(supportedFormats => supportedFormats)  //.forEach(format => log(format)))
			log(`Supported formats: ${supportedFormats}`)
			const barcodeDetector = new BarcodeDetector({formats: supportedFormats})
			barcodeDetector.detect(img)
				.then(barcodes => barcodes.forEach((barcode) => log(barcode.rawData)))
				.catch(err => log(err))
		}
	</script>
</body>

</html>