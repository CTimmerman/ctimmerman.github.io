<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Camera / QR scanner, by Cees Timmerman 2022-08-07</title>
	<link rel="icon"
		href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%222 4 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“·</text></svg>">
	<style>
		html {
			background-color: #444;
			color: white;
		}

		img {
			width: 240px;
		}

		.box {
			background: #ffffff99;
			border: 1px solid red;
			color: black;
			font-size: 0.5em;
			position: absolute;
			word-break: break-all;
		}
		.label {
			background-color: white;
			border: 1px solid blue;
			color: black;
		}

		#pix {
			overflow: auto;
		}

		#vu {
			background: linear-gradient(red, lightgreen);
			border: 1px solid red;
		}
	</style>
</head>
<body>
	<div>
		<label for="audioSource">Audio: </label><select id="audioSource"></select>
		<label for="videoSource">Video: </label><select id="videoSource"></select>
		<button onclick="snap()">Snapshot</button>
		<label for="vu-trigger">Autosnap at </label><input id="vu-trigger" onchange="vu_trigger = parseInt(this.value)" type="number" size="4" max="120" min="-1" value="69">
	</div>
	<div id="log"></div>
	<table>
		<tr>
			<td nowrap>
				<canvas id="vu" width="50" height="100"></canvas>
				<video autoplay muted playsinline></video>
				<div id="overlay"></div>
			</td>
			<td>
				<div id="pix"></div>
			</td>
		</tr>
	</table>
	<script>
		'use strict'
		onbeforeunload = () => false

		const el = id => document.getElementById(id)
		const pixEl = el('pix')
		const logEl = el('log')
		const vu = el('vu').getContext('2d')
		vu.fillStyle = 'white'
		const vidEl = document.querySelector('video')
		const vidX = vidEl.offsetLeft
		const vidY = vidEl.offsetTop
		const overlay = el('overlay')
		const audSel = document.querySelector('select#audioSource')
		const vidSel = document.querySelector('select#videoSource')
		audSel.onchange = setSource
		vidSel.onchange = setSource
		let vu_trigger
		el('vu-trigger').onchange()

		navigator.mediaDevices.enumerateDevices().then(devices => {
			devices.forEach(device => {
				const option = document.createElement('option')
				option.value = device.deviceId
				if (device.kind === 'audioinput') {
					option.text = device.label || `Microphone ${audSel.length + 1}`
					audSel.appendChild(option)
				} else if (device.kind === 'videoinput') {
					option.text = device.label || `Camera ${vidSel.length + 1}`
					vidSel.appendChild(option)
				}
			})
		}).catch(err => log(err))

		let scanner = null
		let barcodeDetector = null
		async function setSource() {
			const audioSource = audSel.value
			const videoSource = vidSel.value
			const query = {
				audio: { deviceId: audioSource ? { exact: audioSource } : undefined },
				video: { deviceId: videoSource ? { exact: videoSource } : undefined },
			}
			await navigator.mediaDevices.getUserMedia(query)
				.then(async src => {
						vidEl.srcObject = src
						await sleep(1000).then(a => {
							el('pix').style.height = getComputedStyle(vidEl).height
							vu.canvas.height = parseInt(getComputedStyle(vidEl).height)
							listen(src)
						})
					}
				)
				.catch(err => {
						log(err)
						throw(err)
					}
				)
			
			if (!('BarcodeDetector' in window)) return
			barcodeDetector = new BarcodeDetector()
			clearInterval(scanner)
			scanner = setInterval(scan, 500)
		}

		async function snap() {
			var canvas = document.createElement('canvas')
			canvas.width = vidEl.videoWidth
			canvas.height = vidEl.videoHeight
			canvas.getContext('2d').drawImage(vidEl, 0, 0)
			/*
			// download
			const a = document.createElement('a')
			a.download = "screenshot.jpg"
			a.href = canvas.toDataURL('image/jpg')
			a.click()
			*/
			const img = document.createElement('img')
			img.src = canvas.toDataURL('image/jpg')
			img.onclick = e => scan(img)
			pixEl.appendChild(img)
			await sleep(200)
			img.scrollIntoView()

			if (!barcodeDetector) return
			const barcodes = await scan(img)
			const label = document.createElement('div')
			label.className = 'label'
			barcodes.forEach(barcode => {
				label.innerHTML += `${barcode.format} <a href="${barcode.rawValue}" target="_blank">${barcode.rawValue}</a><br>`
			})
			pixEl.appendChild(label)
		}

		const log = msg => logEl.innerHTML += msg + '<br>'
		const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms))

		async function scan(img) {
			if (!img) img = vidEl
			const barcodes = await barcodeDetector.detect(img)
			overlay.innerText = ''
			for (let i = 0; i < barcodes.length; ++i) {
				let barcode = barcodes[i]
				let box = document.createElement('div')
				box.className = 'box'
				box.innerHTML = `<a href="${barcode.rawValue}" target="_blank">${barcode.rawValue}</a>`
				box.style.left = (vidX + barcode.boundingBox.x) + 'px'
				box.style.top = (vidY + barcode.boundingBox.y) + 'px'
				box.style.height = barcode.boundingBox.height + 'px'
				box.style.width = barcode.boundingBox.width + 'px'
				overlay.appendChild(box)
			}
			return barcodes
		}

		// https://codepen.io/travisholliday/pen/AxmyVd
		function listen(stream) {
			const audioContext = new AudioContext()
			const analyser = audioContext.createAnalyser()
			const microphone = audioContext.createMediaStreamSource(stream)
			const javascriptNode = audioContext.createScriptProcessor(2048, 1, 1)

			analyser.smoothingTimeConstant = 0.5
			analyser.fftSize = 1024

			microphone.connect(analyser)
			analyser.connect(javascriptNode)
			javascriptNode.connect(audioContext.destination)
			javascriptNode.onaudioprocess = function() {
				const array = new Uint8Array(analyser.frequencyBinCount)
				analyser.getByteFrequencyData(array)
				let total = 0
				const length = array.length
				for (let i = 0; i < length; ++i) total += array[i]
				const level = total / length * 2
				const percentage = level / 100
				const h  = vu.canvas.height
				vu.clearRect(0, 0, 50, h)
				vu.fillStyle = '#444'
				vu.fillRect(0, 0, 50, h - level/100*h)
				vu.fillStyle = 'white'
				vu.font = '32px impact'
				vu.fillText(Math.round(level), 0, h/2)
				if (level >= vu_trigger) snap()
			}
		}
	</script>
</body>
</html>