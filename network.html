<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Network Monitor by Cees Timmerman</title>
	<link rel="icon"
	href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 112 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“Š</text></svg>">
	<style>
		* {
			background-color: black;
			color: white;
			font-family: monospace;
			font-size: 5mm;
			margin: 0;
			text-align: center;
		}
		canvas {
			background: linear-gradient(red, lightgreen);
			border: 1px solid white;
		}
		#interval {
			width: 4em;
		}
	</style>
</head>
<body>
	<audio autoplay loop id="woke">
		<source src="tournament/silent.ogx" type="audio/ogg">
		Your browser does not support the audio element used to keep the page active.
	</audio>
	<p>
		<label for="target">Target IP: </label><input id="target" value="192.168.178.1">
		<label for="interval">Interval ms: </label><input id="interval" value="50">
	</p>
	<canvas id="canvas" width="1000" height="200">
		Ping time to IP.
	</canvas>
	<script>
		'use strict'
		onbeforeunload = () => false  // Prevent accidental reload on swipe up.

		let ch, cw, ctx
		let data = []
		let next_ping = new Date()
		function main(){
			addEventListener('mousedown', ()=>window.woke.play())
			const canvas = document.getElementById('canvas')
			ch = canvas.clientHeight
			cw = canvas.clientWidth
			for(let i = 0; i < cw; ++i) data.push(0)
			ctx = canvas.getContext('2d')
			ping()
		}

		function ping() {
			let e = document.createElement('img')
			let start_time = new Date().getTime()
			e.onerror = () => {
				update(new Date().getTime() - start_time)
			}
			e.src = window.target.value
		}

		function update(ms){
			data = data.slice(1)
			data.push(ms)
			ctx.clearRect(0, 0, cw, ch)
			ctx.fillStyle = '#000'
			let not_zero = 0
			let sum = 0
			for(let i = 0; i < cw; ++i){
				ctx.fillRect(i, 0, 1, ch - data[i])
				if(data[i] > 0) {
					not_zero += 1
					sum += data[i]
				}
			}
			ctx.fillStyle = '#fff'
			ctx.fillText(`Avg. ${Math.round(sum / not_zero)} ms`, 10, 20)
			const now = new Date().getTime()
			setTimeout(ping, next_ping - now)
			next_ping = now + parseInt(window.interval.value)
		}

		addEventListener('load', main)
	</script>
</body>

</html>
